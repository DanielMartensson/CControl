/*
 ============================================================================
 Name        : qmpc.c
 Author      : <Your Name Here>
 Version     : 1.0
 Copyright   : MIT
 Description : Model Predictive Control with integral action and constraints on inputs and outputs
 ============================================================================
 */

#include "CControl/ccontrol.h"

#define row_a 1
#define column_b 1
#define row_c 1
#define row_ai (row_a + column_b)
#define column_bi column_b
#define row_ci row_c
#define N 5
#define DATA_LENGTH 1750

int main() {

	/*
	 * Notice that this is linear MPC. If you're dealing with non-linear systems, use:
	 * - Multiple linear models and replace the models depending on the state vector
	 * - Kalman filter (Unscented Kalman Filter is preferred) for estimating the state vector
	 *
	 * If you want to understand Model Predictive Control, you should go to this page:
	 * https://github.com/DanielMartensson/MataveControl/
	 */

	 /* Create A matrix */
	float A[row_a * row_a] = { 9.9154e-01 };

	/* Create B matrix */
	float B[row_a * column_b] = { 4.8969e-03 };

	/* Create C matrix */
	float C[row_c * row_a] = { 1 };

	/* Create Ai matrix */
	float Ai[row_ai * row_ai];

	/* Create Bi matrix */
	float Bi[row_ai * column_bi];

	/* Create Ci matrix */
	float Ci[row_ci * row_ai];

	/* Add integral action */
	ssint(A, B, C, Ai, Bi, Ci, row_a, column_b, row_c);

	/* Create PHI matrix */
	float PHI[(N * row_ci) * row_ai];
	obsv(PHI, Ai, Ci, row_ai, row_ci, N);

	/* Create GAMMA matrix */
	float GAMMA[(N * row_ci) * (N * column_bi)];
	cab(GAMMA, PHI, Bi, Ci, row_ai, row_ci, column_bi, N);

	/* Create data */
	const float setpoint[DATA_LENGTH] = { 0,335.926,335.926,335.926,335.841,335.926,335.926,335.926,335.926,335.841,335.926,335.841,335.841,335.926,335.841,335.926,335.841,335.841,335.841,334.899,150,150,150.086,150,150,150,150,150,150,150.086,150,150,150,150.086,150.086,150,150.086,150,150,150,150,150,150,150,150,150,150,150.086,150,150,150.086,150,150,150,150,150,150,150,150.086,150,150.086,150,150,150,150,150,150,150.086,150,150.086,150,150,150,150.171,150,150.086,150,150,150.171,150,150.086,150,150,150.086,150,150.086,150,150,150.086,150,150,150.086,150,150,150,150,150,150,150.086,150,150,150,150,150,150.086,150.086,150,150.086,150,150,150.086,150,150,150,150,150.086,150.086,150.086,150,150,150,150,150,150.086,150,150,150,150,150,150,150,150,150,150.086,150,150,150,150.086,150,150,150.086,150.086,150,150,150.086,150.086,150.257,150,150,150.086,150.086,150.086,150,150,150,150.086,150,150.086,150,150.086,150,150.086,150,150.086,150,150,150,150.086,150,150,150,150,150,150,150,150,150,150,150,150,150,150.086,150,150,150,150,150,150,150.086,150.086,150,150,150,150,150,150,150,150,150,150.086,150,150,150,150,150,150,150,150,150,150,150,150.086,150,150,150,150,150.086,150,150,150.086,150.086,150,150.086,150.086,150,150.086,150,150.086,150,150,150,150,150,150,150.086,150.086,150.086,150,150.086,150,150,150.086,150,233.757,302.869,303.212,303.126,303.212,303.126,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.297,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.297,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.126,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.126,303.297,303.126,303.212,303.297,303.126,303.212,303.212,303.212,303.297,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.297,303.212,303.212,303.212,303.212,303.126,303.212,303.212,303.212,303.212,303.212,303.297,303.212,303.212,303.212,303.212,303.297,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.297,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.212,303.297,303.212,303.212,303.297,303.212,303.212,303.212,303.297,303.212,303.297,303.212,303.212,303.212,303.297,303.212,303.212,303.212,303.212,303.212,303.212,303.297,303.297,303.212,303.297,303.212,303.297,303.212,303.297,303.126,303.297,303.212,303.297,303.212,303.212,303.212,303.212,303.212,303.126,303.297,303.212,303.212,303.297,303.212,303.212,303.212,303.297,303.212,303.212,303.212,303.212,303.297,303.297,303.212,309.121,398.444,398.444,398.53,398.444,398.53,398.444,398.53,398.444,398.444,398.444,398.444,398.444,398.444,398.444,398.444,398.444,398.53,398.53,398.53,398.53,398.444,398.444,398.53,398.53,398.444,398.53,398.53,398.444,398.444,398.444,398.53,398.53,398.359,398.53,398.53,398.444,398.53,398.444,398.53,398.53,398.53,398.444,398.444,398.53,398.444,398.444,398.444,398.53,398.53,398.53,398.444,398.53,398.444,398.53,398.53,398.444,398.444,398.53,398.53,398.53,398.53,398.53,398.444,398.444,398.53,398.444,398.53,398.444,398.53,398.444,398.53,398.53,398.53,398.53,398.53,398.444,398.444,398.53,398.53,398.444,398.444,398.53,398.53,398.53,398.53,398.53,398.53,398.444,398.444,398.615,398.444,398.444,398.444,398.444,398.444,398.444,398.53,398.53,398.444,398.53,398.53,398.444,398.53,398.444,398.53,398.53,398.444,398.53,398.53,398.444,398.444,398.53,398.53,398.444,398.359,398.359,398.53,398.53,398.53,398.444,398.444,398.53,398.444,398.444,398.444,398.53,398.53,398.444,398.53,398.53,398.444,398.444,398.444,398.53,398.444,398.53,398.53,398.444,398.53,398.444,398.53,398.444,398.444,450.086,450.086,450.086,450.171,450.086,450,450,450,450.086,450,450.086,450,450.086,450,450.086,450,450.086,450,450,450.086,450,450.086,450.086,450.086,450,450.086,450.086,450.086,450.086,450.086,450.086,450.086,450,450.086,450.086,450.086,450,450,450.086,450,257.394,150,150.086,150,150,150,150,150,150,150,150,150.086,150,150.086,150,150.086,150,150.171,150,150,150,150.086,150,150,150,150,150,150,150,150,150,150,150,150.086,150.086,150,150,150,150.086,150,150,150,150.086,150.086,150,150,150,150,150,150,150.086,150,150,150,150,150,150,150,150,150,150,149.914,150,150,150,150,150,150.086,150.086,150,150,150,150,150,150,150,150,150,150,150,150,149.914,149.914,150,150.086,150,150,150,150,150.086,150,150,150,150,150,150,150,150.086,150.086,150,150.086,150,150,150.086,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,149.914,150,150.086,150,150,150,150,150,150.086,150,150,150,150,150.086,150,150,150.086,150,150,150,150.086,150,150,150,150.086,150,150,150,150,150,150,150,150,150,150,150,150.086,150,150,150,150,150,150,150,150.086,150,150,150,150,150,150,150,150.171,150,150,150,150,150.086,150,150,150.086,150,149.914,150,150,150,150,150,150,150,150,150,150,150,150,150.086,150,150,150.086,150,150.086,150,150,150,150,240.265,450,450,450,450,450,450,450,450,450.086,450,450,450,450,450,450,450,450,450,450,449.914,450,450,450,450.086,450,449.914,450,450,450,450,449.914,450,450,450,450,449.914,450,450,450,450,450,450,450,450.086,450,450,450,450,450,450,450,449.914,450,449.914,450,450,450,449.914,450.086,449.829,450,450,449.914,450,449.914,450,450,449.914,450,450,450,450,450,450,450,450,450,450,450,450,449.914,449.914,450,450.086,450,450,450,450,450,449.914,450,450,450,450,450,450,450,450,450,449.914,450,449.914,450,450,450,450,450,450,450,450,450,450,450.086,450,449.914,450,450,450,449.914,450,450.086,450,450,449.914,450,450,449.914,450,450,450.086,450,450,450.086,450.086,450,450,450,449.914,449.914,450,450,450,449.914,450,450,450,450,449.829,449.914,450,450,450,450,450,450,450,450,450,450,449.829,450,450,450,450,450,449.914,450,449.914,450,450,450,450,449.914,450,449.914,450,450,450,450,450,450,449.914,449.914,449.829,450,450,450,449.914,450,450,450,450,450,449.914,450,450,450,450,449.914,450,450,449.914,450,450,450,450,450,449.914,450,449.914,450,450,450,449.914,450,449.914,450,450,450,449.914,449.914,449.914,450,450,450,450,450,450,450,449.914,449.914,450,450,449.914,450,450,450,450,450,450,449.914,450,450,450,450,450,449.914,450,450,449.914,449.914,449.829,450,450.086,450,450,449.914,450,449.914,450,450,450,450,449.914,450,450,450.086,450,450,450,450,450,450,449.914,450.086,450,450,449.914,450,449.914,449.914,449.914,450,450,449.914,450,450,449.914,449.743,449.914,449.914,450,450,450,449.914,449.914,450,450,450,450,449.914,450,449.914,449.914,450,450,450,450,450,449.914,450,449.914,449.914,449.914,450,450,450,449.914,450,449.829,450,450,449.914,449.914,449.914,449.914,449.829,449.914,450,450,450,450,450,450,450,450,450,450,450,450,449.914,450,450,449.914,450,450,450.086,450,450,450,450,450,449.914,450,450,449.914,449.914,449.914,449.914,449.914,450,449.914,450,449.829,450,450,450,450.086,450.086,450,450,450,450,450,449.914,450,450,450,450,450,449.914,450,450,450,450,450,450,450,450,450,450,450,450,450,450,450,449.914,450,450,450,450,450,450,450,450,450,450,450.086,450,450,450,450,450,450,450,450,450,450,450,450,450,450,450,450,450.086,450,450,450,449.914,450,449.914,449.914,450,450,450,450,449.914,450,450,449.914,450,450,450,450,450,450,449.914,450,450,450,450,449.914,450,450,450,449.829,450,450,449.914,450,450,450,450,450,450,450,450,450,450,450,450,450,450,450,449.914,449.914,450,450,449.914,449.914,450,449.914,450,450,449.914,449.914,449.914,450,450,450,449.914,450,450,450,450,450,449.914,449.914,449.914,449.914,449.914,450,450,450,450,450,450,450,450,450,450,450,450,449.914,450,450,450,450,450,450,450,450,450,450,449.914,450,450,450,450,449.914,450,450,450,450,450,450,449.914,450,450,450,450,450,450,450,450,450,450,450,450,450,450,450,450,450,450,450,449.914,450.086,450,450,449.914,450,450,450,450,450,450,450,450,450,450,450,450,449.914,449.914,449.914,450.086,450,450,450,450,450,449.914,450,450,450,450,450,450,450,450,449.914,450,450,450,450,450,450,450,450,449.914,449.914,449.914,450,450,450,450.086,450,450,450,450,450,450,450,450,450,449.914,450,450,450,418.398,182.03,150.086,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150.086,150,150,150,150,150,150,150,150,150,150,150.086,150,150,150.086,150,150,150,150,150,150,150,150.086,150.086,150,149.914,149.914,150,150,150,150.086,150,150,150,150,150,150.086,150,150,150,150.086,150,150,150,150,150,150,150,150,150,150,150,150.086,150,150.086,150.086,150,150,150,150,150.086,150.086,150,150.086,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150.086,150,150,150,150.086,150,150.086,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150.086,150.086,150,150,150.086,150,150,150,150.086,150,150,150.086,150,150.086,150,150,150,150,150,150,150,150,150,150,150,150,150,150.086,150,150,150,150,150,150.086,150,150,150,150,150.086,150.086,150.086,150.086,150,150.086,150,150,150.086,150,150,150,150.086,150,150.086,150,150,150.086,150,150,150,150.086,150.086,150,150.086,150.086,150,150,150.086,150,150,150,150.171,150,150,150,150.086,150,149.914,150,150,150,150,150,150,150,150.086,150.086,150,150,150,150.086,150,150.086,150,150,150,150,150.086,150.086,150,150.086,150,150,150,150,150,150,150,150,149.914,150,150,150.086,150,150,150,150,150,150,150,150,150,150,150.086,150.086,150,150,150,150,150,150,150.171,150.086,150.086,150,150,150.086,150,150,150,150.086,150,150,149.914,150,150.086,150,150,150,150,150,150,150,150,150.086,149.914,149.914,150,150,150,150,150,150,150.086,150,150.086,150,150,150,150,150,150,150,150,150,150,150,150.086,150,150.086,150,150.086,150,150,150.086,150,150,150,150,150,150,150.086,150.086,150,150,150,150,150,150,150,150,150.086,150.086,150,150,150,149.914,150,150,150.086,150.086 };
	const float temperature[DATA_LENGTH] = { 0,199.438,199.438,200.578,199.362,199.286,199.438,199.97,199.362,200.578,199.362,199.134,199.134,199.286,199.362,198.906,199.362,199.362,199.286,199.438,197.919,195.867,194.728,193.436,191.537,190.473,189.638,188.498,187.131,186.143,185.231,184.244,182.648,181.889,181.281,180.217,178.926,177.938,177.102,176.267,175.431,174.519,174.064,173.38,172.392,171.253,170.569,170.493,170.721,169.809,169.277,168.898,166.011,165.175,165.175,164.795,163.124,162.516,162.592,162.06,160.769,160.313,163.352,163.428,158.413,157.882,157.274,156.742,155.982,155.83,155.375,155.527,154.539,154.083,153.551,153.323,152.792,152.26,151.88,151.424,151.424,150.968,150.057,150.133,148.993,148.841,148.537,148.005,147.701,147.246,146.942,147.018,146.258,145.802,145.574,145.878,144.739,144.587,144.435,144.207,144.055,143.751,143.751,143.371,142.459,142.307,142.004,142.004,141.472,141.092,140.636,141.472,140.408,140.104,139.876,139.8,139.572,139.496,139.421,139.193,138.281,138.813,138.281,138.129,138.281,137.977,137.369,137.141,136.989,137.065,136.837,137.065,136.154,135.926,136.23,135.926,136.382,136.23,135.394,135.09,135.242,135.09,134.482,134.102,134.178,134.102,133.799,133.875,133.571,133.495,133.191,132.963,132.735,132.811,132.279,132.355,132.279,132.355,132.051,132.051,131.899,131.519,131.443,131.216,132.735,131.064,131.14,130.912,130.912,131.064,130.988,131.14,130.532,130.532,130.836,130.76,130.304,130.988,130.76,130.76,130,130.076,130,129.924,130.304,130.076,129.696,129.62,129.468,129.468,129.62,129.012,128.784,129.088,128.86,128.86,128.936,128.784,128.708,128.633,128.481,128.481,128.405,128.481,128.177,128.481,128.253,128.481,128.253,128.784,128.557,128.025,128.177,128.329,128.177,128.025,127.873,127.645,127.797,127.493,127.721,128.177,127.265,127.569,127.189,127.873,127.949,127.569,127.265,127.341,127.417,127.493,127.493,128.329,126.961,127.037,126.809,126.885,126.733,127.113,126.733,126.885,126.885,128.025,129.24,130.608,131.823,132.355,133.419,135.09,136.761,137.369,138.129,139.421,140.332,140.864,142.231,145.422,146.258,145.042,145.346,147.398,148.385,147.777,147.929,148.765,149.753,150.436,150.892,151.956,152.867,153.779,155.071,155.678,155.678,156.21,156.894,157.35,162.288,162.668,163.048,163.504,160.921,161.452,161.68,166.922,162.972,163.276,163.731,166.011,165.555,165.631,167.758,167.91,166.998,167.53,167.986,168.366,168.746,168.746,169.125,169.429,170.189,171.253,171.784,171.253,172.088,172.392,173,173.152,173.38,173.608,173.836,174.216,174.519,174.823,175.203,175.659,176.115,176.343,177.102,177.254,177.027,177.558,177.634,178.242,178.166,178.318,178.85,179.61,179.078,179.534,179.761,181.737,179.913,180.065,180.521,180.521,180.445,180.825,180.977,181.129,181.205,181.585,181.813,182.041,181.889,182.041,182.421,182.648,182.496,182.8,182.952,183.18,182.952,183.332,183.332,183.712,184.168,184.092,184.32,184.624,184.928,185.155,191.233,191.689,185.459,185.611,192.373,190.853,185.991,187.511,186.143,188.346,186.219,186.295,186.295,188.574,186.751,186.675,186.827,186.979,186.751,186.599,186.523,186.447,187.283,187.511,187.359,187.207,186.447,186.675,186.979,187.055,191.537,191.689,187.283,186.827,192.601,192.905,193.512,193.968,187.89,187.89,190.018,189.79,188.042,187.966,187.966,190.322,189.41,189.714,190.625,191.385,191.689,192.221,192.829,194.044,194.576,195.108,195.792,196.475,196.551,197.007,197.387,197.919,198.375,199.362,200.73,200.122,200.882,200.882,201.261,201.565,202.401,203.085,203.617,203.313,203.996,204.224,204.756,204.376,207.491,208.023,207.719,208.479,207.035,208.175,208.175,208.707,208.099,208.327,209.163,209.846,208.935,209.39,210.986,210.378,209.846,210.91,210.226,210.53,211.518,211.29,211.366,212.125,211.518,211.746,212.277,211.67,212.657,213.113,213.037,212.961,212.809,213.417,213.569,213.721,215.62,213.873,213.949,214.557,214.177,214.405,214.633,214.633,215.316,215.088,214.936,215.164,215.24,215.088,215.62,218.051,215.544,215.848,215.848,219.039,216.076,216.228,216.38,216.076,216.38,216.76,217.975,217.975,216.608,218.127,218.583,218.203,217.14,216.912,217.899,218.127,216.608,216.988,217.14,217.595,218.203,217.216,217.367,217.443,217.443,217.443,217.443,217.899,218.203,218.279,217.671,217.595,217.975,218.279,218.203,218.355,219.419,219.419,219.191,217.975,219.419,219.647,219.799,217.975,218.279,218.051,218.279,218.279,218.203,218.203,218.431,218.583,217.899,217.975,217.899,217.899,219.419,218.735,219.571,220.558,220.102,220.482,220.862,220.786,220.786,221.926,222.078,222.078,221.774,221.926,222.306,225.876,223.065,223.293,226.256,227.32,223.369,223.597,225.42,225.193,224.357,224.357,226.256,226.028,224.965,224.737,227.092,224.965,226.484,226.104,226.256,226.408,225.42,225.952,227.32,225.42,222.23,219.951,218.203,217.14,214.101,212.809,211.29,209.846,206.883,205.592,204.604,203.237,201.261,199.97,198.754,197.691,196.627,194.424,193.664,192.373,191.385,190.018,189.182,187.89,187.207,185.307,184.7,183.712,182.421,181.813,181.357,180.065,178.774,177.862,176.875,176.343,176.039,175.507,174.595,174.064,171.784,171.253,170.341,169.657,169.125,168.442,167.91,167.454,166.163,165.783,164.871,164.415,164.947,162.972,162.668,161.756,160.769,160.313,159.857,159.629,158.869,158.186,157.806,157.426,156.97,155.754,155.678,155.223,154.767,153.703,153.095,153.247,152.64,152.26,151.804,152.032,150.588,150.36,150.284,149.829,149.145,148.841,148.461,148.461,147.473,146.942,146.866,146.638,147.549,147.17,147.246,145.27,146.106,144.511,144.587,144.131,143.675,143.371,143.295,143.067,142.459,142.231,142.155,141.928,141.396,142.004,140.636,142.004,140.636,140.484,140.788,140.104,140.028,138.965,138.813,138.889,139.193,139.193,138.357,138.129,138.661,137.901,137.825,137.293,137.141,137.445,137.217,136.458,136.913,136.382,135.926,136.154,137.445,135.698,135.546,135.47,137.445,134.786,134.862,134.558,135.394,134.482,134.482,134.254,133.875,134.862,134.406,133.799,133.343,134.254,134.406,134.102,132.735,132.659,133.039,132.887,132.431,132.355,132.203,132.887,131.975,131.747,131.823,132.127,131.216,131.519,131.443,131.519,130.988,131.064,130.988,130.76,133.267,133.267,130.684,130.76,131.519,131.292,131.14,130.988,130.912,129.924,129.696,130.076,130.076,129.696,129.772,129.696,129.772,129.62,129.544,129.392,129.088,129.316,129.24,128.936,129.164,129.316,128.784,128.86,129.012,128.784,128.708,128.481,128.633,135.698,137.217,139.041,141.168,142.307,143.979,145.422,146.866,150.588,151.956,152.867,154.159,157.274,159.249,159.629,160.996,164.567,164.643,166.694,167.226,169.049,171.025,172.544,172.544,175.659,177.027,177.027,178.394,180.977,181.813,183.028,182.8,186.751,187.89,186.523,187.511,191.005,191.537,193.208,193.588,192.601,193.892,196.931,197.691,196.323,196.931,198.982,199.21,199.59,200.274,201.717,203.009,202.021,202.781,203.237,203.769,203.769,205.972,205.972,205.972,207.947,207.947,207.947,207.947,209.163,210.074,210.454,211.29,211.366,211.973,212.429,213.037,214.86,215.772,214.025,216.532,215.392,216.684,216.684,217.367,216.76,217.064,217.595,217.747,223.901,223.597,224.433,225.117,220.178,220.482,220.558,220.938,223.293,220.862,221.318,221.546,222.078,221.698,222.686,222.686,224.585,224.129,222.913,223.293,225.496,225.345,226.104,224.509,225.42,225.724,226.104,226.18,225.648,225.572,225.724,226.18,230.89,231.65,226.332,227.016,232.258,232.41,227.016,226.94,233.398,233.473,228.079,232.03,228.155,230.663,230.359,228.307,228.687,231.498,231.574,231.27,229.143,228.991,229.219,229.371,230.435,230.055,228.991,229.143,230.511,230.511,231.194,230.814,230.055,230.207,230.587,230.739,230.739,230.814,230.739,230.739,230.359,230.359,230.283,230.283,232.866,230.435,232.562,232.638,231.194,231.346,230.89,230.89,232.182,231.954,232.106,231.042,232.03,231.878,231.802,231.042,231.346,231.498,231.118,231.422,235.905,231.954,231.954,231.878,231.498,233.549,233.777,233.473,231.574,231.65,231.65,231.802,232.79,231.65,231.65,231.726,231.954,232.866,232.866,232.562,231.726,231.802,231.954,231.802,234.157,231.954,231.802,231.954,234.461,233.777,234.081,234.461,231.878,232.03,231.954,233.322,231.726,232.182,232.182,233.17,232.334,232.334,232.486,232.41,232.79,232.638,232.79,231.802,232.79,232.106,232.03,232.03,232.182,232.41,232.79,232.714,232.486,232.334,232.258,232.866,234.765,234.765,234.765,232.714,233.929,232.714,234.461,234.081,232.79,233.018,233.322,233.018,232.486,232.638,232.562,232.79,233.17,232.41,232.638,232.334,233.398,232.638,232.866,232.79,233.701,233.473,233.549,233.701,234.993,233.094,233.246,233.701,235.221,232.79,232.866,232.714,233.777,233.777,233.777,232.714,233.853,233.549,233.777,232.486,234.537,234.461,234.461,234.005,232.714,232.562,233.246,233.473,232.942,233.018,233.018,233.018,232.714,232.866,232.866,233.473,232.79,232.41,232.486,232.866,237.272,232.334,232.486,232.486,234.765,234.385,234.081,232.486,232.638,232.562,232.562,232.334,232.106,232.182,232.182,232.258,232.942,233.094,232.942,233.018,232.03,232.03,232.03,232.106,232.714,231.954,232.03,232.106,232.41,232.41,232.638,232.41,231.878,232.41,232.03,232.182,231.802,231.878,232.106,232.182,231.802,231.65,231.346,231.498,232.714,232.41,232.41,231.574,232.41,232.41,232.334,232.03,232.03,231.65,231.65,231.65,231.574,231.726,231.726,231.726,234.005,234.385,231.27,231.042,234.005,231.118,231.422,231.346,233.018,233.094,233.094,233.018,231.498,231.65,231.65,231.574,232.562,232.79,232.79,232.79,231.802,231.878,231.802,232.486,231.878,232.03,232.182,232.41,222.534,222.534,222.534,222.534,232.79,233.094,233.17,236.436,233.398,233.246,233.094,235.981,232.942,233.018,233.094,233.701,234.233,233.246,233.398,233.398,233.777,234.689,234.689,234.689,233.929,234.005,234.613,234.005,234.081,234.081,234.005,234.157,239.095,234.309,234.385,235.297,234.613,234.461,234.765,235.297,234.765,234.841,234.841,234.993,235.221,235.145,235.221,234.917,235.677,235.677,235.829,235.981,234.993,235.145,235.069,234.461,234.841,234.765,234.841,234.613,235.829,233.853,233.929,233.929,235.753,235.601,235.145,233.853,233.701,233.853,233.701,233.853,233.398,233.322,233.246,233.246,233.549,233.625,233.549,233.398,232.942,232.562,232.562,233.17,235.221,235.297,232.258,232.182,233.625,233.777,233.625,233.473,231.954,231.802,231.574,231.65,231.118,231.118,230.966,230.966,231.65,230.511,230.283,230.663,231.042,230.055,230.89,230.663,231.65,231.422,230.131,231.65,229.751,229.903,229.903,229.827,229.295,229.067,229.067,229.067,229.903,229.751,229.675,228.687,229.599,229.371,229.371,229.675,228.839,228.763,229.067,229.143,229.827,229.903,233.853,234.233,230.435,230.587,230.663,230.663,230.511,231.802,230.663,230.814,231.27,231.878,231.118,231.118,231.574,232.562,232.562,231.574,232.258,232.334,232.41,232.486,232.714,232.866,232.866,233.018,232.334,232.334,232.258,232.638,235.677,235.905,235.981,236.208,233.094,237.12,233.17,233.322,232.638,232.714,232.942,232.79,234.157,234.309,234.081,234.309,233.246,233.17,233.246,233.094,233.701,233.246,233.246,233.549,236.057,236.208,233.777,233.701,236.74,236.816,236.892,237.044,234.385,234.461,234.537,235.753,234.689,234.005,234.613,234.385,233.853,233.929,233.929,235.297,234.081,235.145,235.297,235.525,234.613,234.537,235.677,234.537,235.449,234.537,234.537,234.461,235.525,235.221,235.297,235.449,236.284,234.005,234.765,235.601,234.385,232.106,230.055,227.776,224.889,223.217,221.774,220.178,218.127,216.38,215.164,214.101,210.986,209.77,208.403,206.959,204.756,203.541,202.325,201.034,199.438,198.527,196.931,195.943,194.12,193.133,192.145,191.385,189.562,188.27,187.587,186.903,185.231,184.168,183.256,182.724,182.345,181.281,180.369,179.458,177.482,176.799,175.887,175.279,174.064,174.064,172.772,172.316,170.949,170.189,169.353,168.973,168.442,167.454,166.998,166.163,165.479,164.795,164.415,163.883,162.516,161.832,161.528,160.845,160.465,159.933,159.477,158.793,157.882,157.502,157.882,157.654,156.134,155.602,155.147,154.463,154.159,153.551,153.627,153.171,152.336,152.336,152.336,151.652,151.348,150.892,150.588,149.677,149.829,149.525,149.221,148.765,147.853,147.625,146.942,146.79,146.41,146.03,145.726,145.65,145.042,144.663,144.663,144.359,146.106,145.802,145.574,145.574,142.763,142.687,142.307,142.004,142.763,142.459,141.244,141.016,141.244,141.016,140.864,140.56,139.724,139.572,139.876,139.8,139.269,139.724,139.345,138.585,138.889,138.661,138.433,138.281,137.597,137.673,137.521,137.369,139.193,138.889,138.813,138.281,136.306,136.913,136.761,136.154,135.774,136.23,136.306,136.23,137.825,135.47,135.394,135.318,135.85,135.774,135.546,135.698,134.558,134.254,134.33,134.102,134.102,134.102,133.799,133.571,133.267,133.191,133.039,133.115,132.811,134.33,134.102,132.659,132.507,132.355,132.203,132.963,132.203,131.899,131.823,131.216,130.912,130.532,130.076,129.924,132.051,132.203,131.975,129.24,129.848,129.392,129.696,129.696,130.304,130,129.696,129.24,129.012,129.164,128.936,128.633,128.708,128.86,129.392,128.86,129.012,128.936,128.708,128.329,128.557,128.405,128.557,128.633,129.088,129.012,129.164,128.329,128.481,128.253,128.253,128.405,128.329,128.101,128.101,127.949,128.86,128.177,128.177,128.177,128.329,128.253,128.101,128.101,128.025,122.707,128.025,128.101,129.316,129.088,129.24,129.088,127.341,127.569,127.341,127.645,127.645,127.493,127.797,127.493,127.189,127.949,127.493,129.392,127.645,127.645,127.645,128.557,127.797,127.645,127.949,127.949,130.152,127.949,127.797,127.873,127.873,127.873,127.873,127.645,127.645,127.797,128.86,127.949,128.936,127.797,127.873,128.329,127.797,127.797,127.721,127.645,127.645,129.012,129.012,127.721,128.557,127.721,127.873,127.949,127.569,129.088,127.569,129.468,128.405,128.405,127.721,127.721,127.417,127.797,127.417,127.417,127.949,128.025,128.025,129.012,127.949,127.949,127.949,128.253,127.949,127.949,128.557,127.873,128.177,127.873,127.949,127.797,129.24,127.873,127.797,127.873,128.177,128.329,128.101,127.797,128.025,128.253,127.949,128.025,127.949,127.721,128.405 };

	/* Create vectors */
	float x_qmpc[row_ai] = { 0 };
	float x_kf[row_a] = { 0 };
	float u_qmpc[column_bi] = { 0 };
	float r_qmpc[row_ci] = { 0 };
	float output[DATA_LENGTH] = { 0 };

	/* Constants */
	const float Umax_qmpc[column_bi] = { 1000.0f };
	const float S_qmpc[row_ci] = { 2.0f };
	const float I_qmpc = 0.2f;
	const float lambda_qmpc = 0.1f;
	const bool has_integration = true;
	const float R_kf[row_c * row_c] = { 1.0f };
	const float Q_kf[row_a * row_a] = { 0.05f };
	const float P_kf[row_a * row_a] = { 1.0f };

	clock_t start, end;
	float cpu_time_used;
	start = clock();

	/* These functions should be placed inside a while-loop inside a microcontroller */
	size_t i;
	for (i = 0; i < DATA_LENGTH; i++) {
		const bool status_kf = kf(A, B, C, u_qmpc, &temperature[i], Q_kf, R_kf, x_kf, P_kf, row_a, row_c, column_b);
		if (status_kf) {
			/* Important to set the reference as setpoint */
			r_qmpc[0] = setpoint[i];

			/* This are the state for the model for MPC 
			 * because the state of qmpc model with integral action is x_mpc = [x_est; u(k-1)] 
			 */
			x_qmpc[0] = x_kf[0];   /* Estimated state vector */
			x_qmpc[1] = 0;// u_qmpc[0]; /* Past input signal */

			/* Compute next u_qmpc */
			const bool status_qmpc = qmpc(GAMMA, PHI, x_qmpc, u_qmpc, Umax_qmpc, S_qmpc, r_qmpc, row_ai, row_ci, column_bi, N, lambda_qmpc, has_integration, I_qmpc);
			if (status_qmpc) {
				output[i] = u_qmpc[0];
			}
			else {
				printf("The output was not optimized at index %i", i);
				break;
			}
		}
		else {
			printf("The state was not estimated at index %i", i);
			break;
		}
	}

	end = clock();
	cpu_time_used = ((float)(end - start)) / CLOCKS_PER_SEC;
	printf("\nTotal speed  was %f\n", cpu_time_used);

	/* Print the output */
	print(output, DATA_LENGTH, 1);

	/* Detect memory leak */
	detectmemoryleak();

	return EXIT_SUCCESS;
}

/* GNU octave code:
% You need to install MataveControl from GitHub https://github.com/DanielMartensson/MataveControl/

close all
clear all
clc

sys = mc.ss(0, [0 1; -1 -1], [0;1], [1 0]); % SISO state space model

sysd = mc.c2d(sys, 0.5); % To discrete

R = [6]; % Reference for the SISO model. If MIMO -> R need to be a vector
N = 10; % Horizon predict constant
T = 35; % Horizon time constant
lambda = 7; % Regularization for smoother inputs u

[y, t, x, u] = mc.lmpc(sysd, N, R, T, lambda); % Simulate MPC with linear programming
hold on
plot(t, u)

I = 0.2; % Integral action constant
Umax = [0.4]; % Maximum input signal vector
S = [2]; % Slack variable says that the output can be +2 over the reference R, in this case: 6+2 = 8
lambda = 0.2; % Regularization for smoother inputs u
figure(2); % New figure
x0 = [-8; 20];
[y, t, x, u] = mc.qmpc(sysd, N, R, T, lambda, Umax, S, I, x0); % Simulate MPC with quadratic programming
hold on
plot(t, u)
*/